<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Dashboard - Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
    <style>
        #topbar {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            height: 56px;
            background-color: #1e1e2f;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 24px;
            z-index: 100;
            border-bottom: 1px solid #33334d;
        }

        #main-content {
            margin-left: 250px;
            padding: 20px;
            margin-top: 56px;
        }

        .profile-wrap { position: relative; }

        .profile-btn {
            background: #33334d;
            border: 1px solid #555;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .profile-btn:hover { border-color: #9146ff; background: #3e3e5f; }
        .profile-btn svg { width: 20px; height: 20px; fill: #ccc; }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 48px;
            right: 0;
            background: #2b2b3f;
            border: 1px solid #555;
            border-radius: 8px;
            min-width: 180px;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 200;
        }

        .profile-dropdown.open { display: block; }
        .profile-dropdown .label { font-size: 0.75rem; color: #888; margin-bottom: 4px; }

        .profile-dropdown .username {
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-dropdown .username::before {
            content: '';
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #4ade80;
            flex-shrink: 0;
        }

        .profile-dropdown hr { border-color: #444; margin: 10px 0; }

        .profile-dropdown a {
            display: block;
            color: #ccc;
            font-size: 0.875rem;
            text-decoration: none;
            padding: 4px 0;
            transition: color 0.15s;
        }

        .profile-dropdown a:hover { color: #fff; }

        .settings-card { max-width: 560px; }

        .form-control {
            background-color: #2b2b3f;
            border: 1px solid #555;
            color: #fff;
        }

        .form-control:focus {
            background-color: #2b2b3f;
            border-color: #9146ff;
            color: #fff;
            box-shadow: 0 0 0 0.2rem rgba(145, 70, 255, 0.25);
        }

        .form-control::placeholder { color: #888; }
        .form-label { color: #ccc; font-size: 0.9rem; }

        .form-control[readonly] {
            color: #aaa;
            cursor: default;
            font-size: 0.85rem;
        }

        #settings-msg, #key-msg {
            font-size: 0.875rem;
            min-height: 22px;
        }

        .key-warning {
            font-size: 0.78rem;
            color: #f87171;
            margin-top: 6px;
        }

        .section-divider {
            border-color: #444;
            margin: 20px 0;
        }

        .copy-btn {
            white-space: nowrap;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 class="text-center text-white">Stream Tools</h3>
    <a href="/admin/index.html">Dashboard</a>
    <a href="/admin/wheel.html">Wheel Manager</a>
	<a href="#">Stats</a>
    <a href="/admin/settings.html">User Settings</a>
	<a href="/admin/users.html" id="adminNavItem" style="display:none;">User Management</a>
    <a href="#" id="logoutBtn" style="position:absolute; bottom:20px; width:100%; text-align:center;">Log Out</a>
</div>

<div id="topbar">
    <div class="profile-wrap">
        <div class="profile-btn" id="profileBtn" title="Profile">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
            </svg>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
            <div class="label">Signed in as</div>
            <div class="username" id="profileUsername">...</div>
            <hr>
            <a href="/admin/settings.html">Settings</a>
            <a href="#" id="dropdownLogout">Log Out</a>
        </div>
    </div>
</div>

<div id="main-content">
    <h2>Settings</h2>

    <div class="settings-card">

        <!-- Browser Source URL card -->
        <div class="card p-3 mb-3">
            <h5>Browser Source URL</h5>
            <p class="text-muted" style="font-size:0.85rem;">
                Use this unique URL as your OBS browser source. It is tied to your account.
            </p>

            <label class="form-label">Your Wheel URL</label>
            <div class="input-group mb-2">
                <input type="text" class="form-control" id="wheelUrlInput" readonly placeholder="Loading...">
                <button class="btn btn-outline-secondary copy-btn" id="copyUrlBtn" type="button">Copy</button>
            </div>

            <hr class="section-divider">

            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div style="font-size:0.9rem; color:#ccc; font-weight:500;">Regenerate Key</div>
                    <div class="key-warning">⚠ This will break your existing OBS browser source URL.</div>
                </div>
                <button class="btn btn-danger btn-sm ms-3" id="regenKeyBtn">Regenerate</button>
            </div>
            <div id="key-msg" class="mt-2"></div>
        </div>

        <!-- Change Credentials card -->
        <div class="card p-3">
            <h5>Change Credentials</h5>
            <p class="text-muted" style="font-size:0.85rem;">Update your admin username and password below.</p>

            <div class="mb-3">
                <label for="newUsername" class="form-label">New Username</label>
                <input type="text" class="form-control" id="newUsername" placeholder="Enter new username">
            </div>

            <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input type="password" class="form-control" id="newPassword" placeholder="Enter new password">
            </div>

            <button class="btn btn-primary" id="saveSettings">Save Changes</button>
            <div id="settings-msg" class="mt-2"></div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentWheelKey = null;

    function buildWheelUrl(key) {
        return `${window.location.protocol}//${window.location.host}/wheel/mainWheel?key=${key}`;
    }

    function setWheelUrl(key) {
        currentWheelKey = key;
        document.getElementById('wheelUrlInput').value = buildWheelUrl(key);
    }

    // Load profile + wheel key
    fetch('/api/me', { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
            document.getElementById('profileUsername').textContent = data.username;
            if (data.wheelKey) {
                setWheelUrl(data.wheelKey);
            } else {
                document.getElementById('wheelUrlInput').placeholder = 'No key yet — click Regenerate to create one';
            }
        });

    // Copy URL button
    document.getElementById('copyUrlBtn').onclick = () => {
        const input = document.getElementById('wheelUrlInput');
        if (!input.value) return;
        navigator.clipboard.writeText(input.value).then(() => {
            const btn = document.getElementById('copyUrlBtn');
            btn.textContent = 'Copied!';
            btn.classList.replace('btn-outline-secondary', 'btn-success');
            setTimeout(() => {
                btn.textContent = 'Copy';
                btn.classList.replace('btn-success', 'btn-outline-secondary');
            }, 2000);
        });
    };

    // Regenerate key
    document.getElementById('regenKeyBtn').onclick = async () => {
        const keyMsg = document.getElementById('key-msg');
        const confirmed = confirm('Are you sure? Your current OBS browser source URL will stop working and you\'ll need to update it with the new URL.');
        if (!confirmed) return;

        try {
            const res = await fetch('/api/regenerate-key', {
                method: 'POST',
                credentials: 'include'
            });
            const data = await res.json();
            if (data.success) {
                setWheelUrl(data.wheelKey);
                keyMsg.textContent = 'Key regenerated! Update your OBS browser source with the new URL above.';
                keyMsg.style.color = '#4ade80';
            } else {
                throw new Error('Failed');
            }
        } catch (err) {
            keyMsg.textContent = 'Failed to regenerate key. Please try again.';
            keyMsg.style.color = '#f87171';
        }

        setTimeout(() => { keyMsg.textContent = ''; }, 5000);
    };

    // Save credentials
    document.getElementById('saveSettings').onclick = async () => {
        const newUsername = document.getElementById('newUsername').value.trim();
        const newPassword = document.getElementById('newPassword').value;
        const msgDiv = document.getElementById('settings-msg');

        if (!newUsername || !newPassword) {
            msgDiv.innerText = 'Please fill in both fields.';
            msgDiv.style.color = '#f87171';
            return;
        }

        const res = await fetch('/change-credentials', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ newUsername, newPassword })
        });

        if (res.ok) {
            msgDiv.innerText = 'Credentials updated successfully!';
            msgDiv.style.color = '#4ade80';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('profileUsername').textContent = newUsername;
        } else {
            const data = await res.json();
            msgDiv.innerText = 'Error: ' + (data.message || 'Unknown error');
            msgDiv.style.color = '#f87171';
        }

        setTimeout(() => { document.getElementById('settings-msg').textContent = ''; }, 5000);
    };

    // Profile dropdown
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');

    profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profileDropdown.classList.toggle('open');
    });

    document.addEventListener('click', () => profileDropdown.classList.remove('open'));
	fetch('/api/me', { credentials: 'include' })
    .then(r => r.json())
    .then(data => {
		if (data.role === 'admin') {
			document.getElementById('adminNavItem').style.display = 'block';
		}
        document.getElementById('profileUsername').textContent = data.username;
        // Set personal wheel URL
        const url = `${window.location.protocol}//${window.location.host}/wheel/mainWheel?key=${data.wheelKey}`;
        const urlInput = document.getElementById('browserSourceUrl');
        if (urlInput) urlInput.value = url;
    });
    async function doLogout() {
        const res = await fetch('/logout', { method: 'POST', credentials: 'include' });
        if (res.ok) window.location.href = '/login.html';
        else alert('Logout failed.');
    }

    document.getElementById('logoutBtn').onclick = (e) => { e.preventDefault(); doLogout(); };
    document.getElementById('dropdownLogout').onclick = (e) => { e.preventDefault(); doLogout(); };
</script>

</body>
</html>