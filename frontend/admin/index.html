<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stream Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="admin.css">
<style>
    #topbar {
        position: fixed;
        top: 0;
        left: 250px;
        right: 0;
        height: 56px;
        background-color: #1e1e2f;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 0 24px;
        z-index: 100;
        border-bottom: 1px solid #33334d;
    }

    #main-content {
        margin-left: 250px;
        padding: 20px;
        margin-top: 56px;
    }

    .profile-wrap { position: relative; }

    .profile-btn {
        background: #33334d;
        border: 1px solid #555;
        border-radius: 50%;
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
    }

    .profile-btn:hover { border-color: #9146ff; background: #3e3e5f; }
    .profile-btn svg { width: 20px; height: 20px; fill: #ccc; }

    .profile-dropdown {
        display: none;
        position: absolute;
        top: 48px;
        right: 0;
        background: #2b2b3f;
        border: 1px solid #555;
        border-radius: 8px;
        min-width: 180px;
        padding: 12px 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        z-index: 200;
    }

    .profile-dropdown.open { display: block; }
    .profile-dropdown .label { font-size: 0.75rem; color: #888; margin-bottom: 4px; }

    .profile-dropdown .username {
        font-size: 1rem;
        font-weight: bold;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .profile-dropdown .username::before {
        content: '';
        display: inline-block;
        width: 8px; height: 8px;
        border-radius: 50%;
        background: #4ade80;
        flex-shrink: 0;
    }

    .profile-dropdown hr { border-color: #444; margin: 10px 0; }

    .profile-dropdown a {
        display: block;
        color: #ccc;
        font-size: 0.875rem;
        text-decoration: none;
        padding: 4px 0;
        transition: color 0.15s;
    }

    .profile-dropdown a:hover { color: #fff; }
</style>
</head>
<body>

<div id="sidebar">
  <h3 class="text-center text-white">Stream Tools</h3>
  <a href="/admin/index.html" style="background-color: #33334d; color: #fff;">Dashboard</a>
  <a href="/admin/wheel.html">Wheel Manager</a>
	<a href="#">Stats</a>
    <a href="/admin/settings.html">User Settings</a>
  <a href="/admin/users.html" id="adminNavItem" style="display:none;">User Management</a>
  <a href="#" id="logoutBtn" style="position:absolute; bottom:20px; width:100%; text-align:center;">Log Out</a>
</div>

<div id="topbar">
    <div class="profile-wrap">
        <div class="profile-btn" id="profileBtn" title="Profile">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
            </svg>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
            <div class="label">Signed in as</div>
            <div class="username" id="profileUsername">...</div>
            <hr>
            <a href="/admin/settings.html">Settings</a>
            <a href="#" id="dropdownLogout">Log Out</a>
        </div>
    </div>
</div>

<div id="main-content">
  <h2>Dashboard</h2>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <h6 class="text-muted mb-1">Total Categories</h6>
        <h2 id="statCategories">—</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <h6 class="text-muted mb-1">Browser Source</h6>
        <h2><span style="font-size:1rem;color:#4ade80;">● Live</span></h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <h6 class="text-muted mb-1">Wheel URL</h6>
        <p class="mb-0" style="font-size:0.8rem;color:#888;word-break:break-all;"><input type="text" class="form-control" id="browserSourceUrl" readonly></p>
      </div>
    </div>
  </div>

  <div class="card mt-3 p-3">
    <h5>Quick Links</h5>
    <div class="d-flex gap-2 flex-wrap">
      <a href="/admin/wheel.html" class="btn btn-primary">Wheel Manager</a>
      <a href="/admin/settings.html" class="btn btn-outline-secondary">Settings</a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    // Load category count for stat card
    fetch('/api/categories', { credentials: 'include' })
        .then(r => r.json())
        .then(cats => {
            document.getElementById('statCategories').textContent = cats.length;
        })
        .catch(() => {});

    // Profile
    fetch('/api/me', { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
            document.getElementById('profileUsername').textContent = data.username;
        });

    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');

    profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profileDropdown.classList.toggle('open');
    });

    document.addEventListener('click', () => profileDropdown.classList.remove('open'));
	
	fetch('/api/me', { credentials: 'include' })
    .then(r => r.json())
    .then(data => {
		if (data.role === 'admin') {
			document.getElementById('adminNavItem').style.display = 'block';
		}
        document.getElementById('profileUsername').textContent = data.username;
        // Set personal wheel URL
        const url = `${window.location.protocol}//${window.location.host}/wheel/mainWheel?key=${data.wheelKey}`;
        const urlInput = document.getElementById('browserSourceUrl');
        if (urlInput) urlInput.value = url;
    });
    async function doLogout() {
        const res = await fetch('/logout', { method: 'POST', credentials: 'include' });
        if (res.ok) window.location.href = '/login.html';
        else alert('Logout failed.');
    }

    document.getElementById('logoutBtn').onclick = (e) => { e.preventDefault(); doLogout(); };
    document.getElementById('dropdownLogout').onclick = (e) => { e.preventDefault(); doLogout(); };
</script>
</body>
</html>