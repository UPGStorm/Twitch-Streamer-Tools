<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Dashboard - User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
    <style>
        #topbar {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            height: 56px;
            background-color: #1e1e2f;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 24px;
            z-index: 100;
            border-bottom: 1px solid #33334d;
        }

        #main-content {
            margin-left: 250px;
            padding: 20px;
            margin-top: 56px;
        }

        /* Hide admin-only nav item by default until role is confirmed */
        #adminNavItem { display: none; }

        .profile-wrap { position: relative; }

        .profile-btn {
            background: #33334d;
            border: 1px solid #555;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .profile-btn:hover { border-color: #9146ff; background: #3e3e5f; }
        .profile-btn svg { width: 20px; height: 20px; fill: #ccc; }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 48px;
            right: 0;
            background: #2b2b3f;
            border: 1px solid #555;
            border-radius: 8px;
            min-width: 180px;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 200;
        }

        .profile-dropdown.open { display: block; }
        .profile-dropdown .label { font-size: 0.75rem; color: #888; margin-bottom: 4px; }

        .profile-dropdown .username {
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-dropdown .username::before {
            content: '';
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #4ade80;
            flex-shrink: 0;
        }

        .profile-dropdown hr { border-color: #444; margin: 10px 0; }

        .profile-dropdown a {
            display: block;
            color: #ccc;
            font-size: 0.875rem;
            text-decoration: none;
            padding: 4px 0;
            transition: color 0.15s;
        }

        .profile-dropdown a:hover { color: #fff; }

        .form-control {
            background-color: #2b2b3f;
            border: 1px solid #555;
            color: #fff;
        }

        .form-control:focus {
            background-color: #2b2b3f;
            border-color: #9146ff;
            color: #fff;
            box-shadow: 0 0 0 0.2rem rgba(145, 70, 255, 0.25);
        }

        .form-control::placeholder { color: #888; }
        .form-select {
            background-color: #2b2b3f;
            border: 1px solid #555;
            color: #fff;
        }

        .form-select:focus {
            background-color: #2b2b3f;
            border-color: #9146ff;
            color: #fff;
            box-shadow: 0 0 0 0.2rem rgba(145, 70, 255, 0.25);
        }

        .role-badge {
            font-size: 0.72rem;
            padding: 2px 8px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .role-badge.admin {
            background: rgba(145, 70, 255, 0.2);
            color: #b47aff;
            border: 1px solid rgba(145, 70, 255, 0.4);
        }

        .role-badge.user {
            background: rgba(74, 222, 128, 0.1);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .access-denied {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .access-denied h3 { color: #f87171; margin-bottom: 10px; }

        #createMsg { font-size: 0.875rem; min-height: 22px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 class="text-center text-white">Stream Tools</h3>
    <a href="/admin/index.html">Dashboard</a>
    <a href="/admin/wheel.html">Wheel Manager</a>
    <a href="/admin/settings.html">Settings</a>
    <a href="#">Stats</a>
    <a href="/admin/users.html" id="adminNavItem" style="background-color: #33334d; color: #fff;">User Management</a>
    <a href="#" id="logoutBtn" style="position:absolute; bottom:20px; width:100%; text-align:center;">Log Out</a>
</div>

<div id="topbar">
    <div class="profile-wrap">
        <div class="profile-btn" id="profileBtn" title="Profile">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
            </svg>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
            <div class="label">Signed in as</div>
            <div class="username" id="profileUsername">...</div>
            <hr>
            <a href="/admin/settings.html">Settings</a>
            <a href="#" id="dropdownLogout">Log Out</a>
        </div>
    </div>
</div>

<div id="main-content">

    <!-- Shown only if admin -->
    <div id="adminContent" style="display:none;">
        <h2>User Management</h2>

        <!-- Create user -->
        <div class="card p-3 mb-3" style="max-width:520px;">
            <h5>Create New User</h5>
            <div class="mb-3">
                <label class="form-label" style="color:#ccc; font-size:0.9rem;">Username</label>
                <input type="text" class="form-control" id="newUsername" placeholder="Enter username">
            </div>
            <div class="mb-3">
                <label class="form-label" style="color:#ccc; font-size:0.9rem;">Password</label>
                <input type="password" class="form-control" id="newPassword" placeholder="Enter password">
            </div>
            <div class="mb-3">
                <label class="form-label" style="color:#ccc; font-size:0.9rem;">Role</label>
                <select class="form-select" id="newRole">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button class="btn btn-primary" id="createUserBtn">Create User</button>
            <div id="createMsg" class="mt-2"></div>
        </div>

        <!-- User list -->
        <div class="card p-3">
            <h5>All Users</h5>
            <table class="table table-dark table-striped mb-0">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Wheel Key</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>
    </div>

    <!-- Shown if not admin -->
    <div id="deniedContent" style="display:none;">
        <div class="access-denied">
            <h3>Access Denied</h3>
            <p>You need admin privileges to view this page.</p>
            <a href="/admin/index.html" class="btn btn-outline-secondary">Go to Dashboard</a>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentUserId = null;

    // Load profile and check role
    fetch('/api/me', { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
            document.getElementById('profileUsername').textContent = data.username;

            if (data.role === 'admin') {
                document.getElementById('adminContent').style.display = 'block';
                document.getElementById('adminNavItem').style.display = 'block';
                loadUsers();
            } else {
                document.getElementById('deniedContent').style.display = 'block';
            }
        });

    // Load all users into table
    async function loadUsers() {
        try {
            const res = await fetch('/api/users', { credentials: 'include' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const users = await res.json();
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';
            users.forEach(u => addUserRow(u));
        } catch (err) {
            console.error('Failed to load users:', err);
        }
    }

    function addUserRow(u) {
        const tbody = document.getElementById('usersTable');
        if (tbody.querySelector(`tr[data-id="${u._id}"]`)) return;

        const tr = document.createElement('tr');
        tr.dataset.id = u._id;

        const keyDisplay = u.wheelKey
            ? `<span style="font-size:0.75rem; color:#888; font-family:monospace;">${u.wheelKey.slice(0, 8)}...</span>`
            : `<span style="color:#555; font-size:0.8rem;">None</span>`;

        const isSelf = u._id === currentUserId;

        tr.innerHTML = `
            <td style="vertical-align:middle;">${u.username}</td>
            <td style="vertical-align:middle;">
                <span class="role-badge ${u.role}">${u.role}</span>
            </td>
            <td style="vertical-align:middle;">${keyDisplay}</td>
            <td style="vertical-align:middle;">
                ${isSelf
                    ? `<span style="font-size:0.8rem; color:#666;">You</span>`
                    : `<button class="btn btn-sm btn-danger">Delete</button>`
                }
            </td>
        `;

        if (!isSelf) {
            tr.querySelector('button').onclick = async () => {
                if (!confirm(`Delete user "${u.username}"? This cannot be undone.`)) return;
                try {
                    const res = await fetch(`/api/users/${u._id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (!res.ok) {
                        const data = await res.json();
                        alert(data.error || 'Failed to delete user');
                        return;
                    }
                    tr.remove();
                } catch (err) {
                    console.error('Delete user error:', err);
                }
            };
        }

        tbody.appendChild(tr);
    }

    // Create user
    document.getElementById('createUserBtn').onclick = async () => {
        const username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newPassword').value;
        const role = document.getElementById('newRole').value;
        const msgDiv = document.getElementById('createMsg');

        if (!username || !password) {
            msgDiv.textContent = 'Please fill in both fields.';
            msgDiv.style.color = '#f87171';
            return;
        }

        try {
            const res = await fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ username, password, role })
            });

            const data = await res.json();

            if (!res.ok) {
                msgDiv.textContent = data.error || 'Failed to create user';
                msgDiv.style.color = '#f87171';
                return;
            }

            addUserRow(data);
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newRole').value = 'user';
            msgDiv.textContent = `User "${data.username}" created successfully!`;
            msgDiv.style.color = '#4ade80';

            setTimeout(() => { msgDiv.textContent = ''; }, 4000);

        } catch (err) {
            console.error('Create user error:', err);
            msgDiv.textContent = 'Server error. Please try again.';
            msgDiv.style.color = '#f87171';
        }
    };

    // Profile dropdown
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');

    profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profileDropdown.classList.toggle('open');
    });

    document.addEventListener('click', () => profileDropdown.classList.remove('open'));

    async function doLogout() {
        const res = await fetch('/logout', { method: 'POST', credentials: 'include' });
        if (res.ok) window.location.href = '/login.html';
        else alert('Logout failed.');
    }

    document.getElementById('logoutBtn').onclick = (e) => { e.preventDefault(); doLogout(); };
    document.getElementById('dropdownLogout').onclick = (e) => { e.preventDefault(); doLogout(); };
</script>

</body>
</html>
